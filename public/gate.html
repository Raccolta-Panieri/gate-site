<!doctype html>
<html lang="it">
<head><meta charset="utf-8"><title>Gate Telegram Sicuro</title></head>
<body>
  <h1>Verifica per accedere al link</h1>
  <div id="msg" style="color:red"></div>
  <button id="accessBtn">Accedi al gruppo Telegram</button>

  <script>
    const btn = document.getElementById('accessBtn');
    const msg = document.getElementById('msg');
    const token = new URLSearchParams(location.search).get('t');

    btn.addEventListener('click', async () => {
      msg.textContent = '';
      if (!token) { msg.textContent = 'Token mancante nella URL.'; return; }

      try {
        const resp = await fetch('/.netlify/functions/verify-token', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ token })
        });
        const data = await resp.json();
        if (data.success) {
          window.location.href = data.telegram;
        } else {
          msg.textContent = data.error || 'Errore durante la verifica.';
        }
      } catch (e) {
        msg.textContent = 'Errore di rete.';
      }
    });
  </script>
</body>
</html>